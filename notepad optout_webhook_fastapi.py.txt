import os
import json
import gspread
from fastapi import FastAPI, Request
from oauth2client.service_account import ServiceAccountCredentials

app = FastAPI()

# Definir el alcance (scopes)
scope = [
    "https://spreadsheets.google.com/feeds",
    "https://www.googleapis.com/auth/drive"
]

# === ✅ NUEVO MÉTODO (variable de entorno) ===
# Leer el JSON de las credenciales desde Render
creds_json = os.getenv("GOOGLE_CREDS_JSON")

if not creds_json:
    raise Exception("❌ GOOGLE_CREDS_JSON not found. Set it in Render Environment Variables.")

creds_dict = json.loads(creds_json)
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
client = gspread.authorize(creds)
# ============================================

@app.post("/sms/optout")
async def receive_sms(request: Request):
    form = await request.form()
    from_number = form.get("From")
    body = form.get("Body", "").strip().lower()

    if body == "stop":
        sheet = client.open("YourGoogleSheetName").sheet1
        data = sheet.get_all_records()
        for i, row in enumerate(data, start=2):  # Start=2 para saltar el encabezado
            if str(row.get("Phone")) == from_number:
                sheet.update_acell(f"M{i}", "OPT-OUT")
                return {"message": "User opted out."}
        return {"message": "Phone not found in sheet."}

    return {"message": "No opt-out detected."}
